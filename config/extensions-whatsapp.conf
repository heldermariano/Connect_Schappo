; =============================================================
; Dialplan â€” Chamadas WhatsApp Voz recebidas via 360Dialog
; Arquivo: /etc/asterisk/extensions_whatsapp.conf
; Incluir em extensions.conf: #include extensions_whatsapp.conf
; =============================================================

[from-whatsapp]
; Chamada recebida do WhatsApp via SIP/360Dialog
; O caller ID vem como numero do WhatsApp (ex: 5561999887766)

; 1. Log da chamada
exten => _X.,1,NoOp(=== CHAMADA WHATSAPP VOZ ===)
 same => n,NoOp(De: ${CALLERID(num)} Para: ${EXTEN})
 same => n,Set(CDR(accountcode)=whatsapp)
 same => n,Set(__WHATSAPP_CALL=1)

; 2. Horario comercial: seg-sex 07-19h, sab 08-12h
 same => n,GotoIfTime(07:00-19:00,mon-fri,*,*?atender)
 same => n,GotoIfTime(08:00-12:00,sat,*,*?atender)

; 3. Fora do horario -> voicemail
 same => n,Goto(fora-horario,${EXTEN},1)

; 4. Dentro do horario -> fila de atendimento
 same => n(atender),Answer()
 same => n,Wait(1)
 same => n,Playback(custom/boas-vindas-whatsapp)
 same => n,Queue(fila-recepcao,tT,,,60)

; 5. Se ninguem atendeu na fila (timeout 60s) -> voicemail
 same => n,Goto(voicemail-whatsapp,${EXTEN},1)

; --- Contexto para fora do horario ---
[fora-horario]
exten => _X.,1,Answer()
 same => n,Wait(1)
 same => n,Playback(custom/fora-horario)
 same => n,VoiceMail(200@default,u)
 same => n,Hangup()

; --- Contexto voicemail fallback ---
[voicemail-whatsapp]
exten => _X.,1,Answer()
 same => n,Playback(custom/voicemail-whatsapp)
 same => n,VoiceMail(200@default,u)
 same => n,Hangup()

; --- Fila de recepcao (ramais 201-204) ---
; Configurar em queues.conf:
;
; [fila-recepcao]
; strategy=ringall
; timeout=15
; retry=5
; maxlen=10
; joinempty=yes
; leavewhenempty=no
; ringinuse=no
; member => PJSIP/201   ; Renata
; member => PJSIP/202   ; Paula
; member => PJSIP/203   ; Jefferson
; member => PJSIP/204   ; Claudia Santrib
